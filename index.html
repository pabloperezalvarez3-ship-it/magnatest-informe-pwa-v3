<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<link rel="manifest" href="manifest.webmanifest"/>
<title>Informe de Inspección - MAGNATEST</title>
<style>
:root{
  --bg:#0b1220; --sheet:#ffffff; --title:#0f1a2b; --accent:#233884;
  --tb:#dbe1f2; --alt:#f6f8ff; --blue-soft:#b9ccff;
}
*{box-sizing:border-box}
body{margin:0;padding:16px;background:var(--bg);font-family:Arial, Helvetica, sans-serif;color:#111}
.controls{max-width:980px;margin:0 auto 16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.controls button{padding:10px 14px;border-radius:10px;border:1px solid #0f1a2b;background:#0f1a2b;color:#fff;font-weight:600;cursor:pointer}
.sheet{max-width:980px;margin:0 auto;background:var(--sheet);border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);padding:24px 28px 40px;border:1px solid rgba(0,0,0,.08)}
.header{display:grid;grid-template-columns:240px 1fr 160px;gap:10px;align-items:center;margin-bottom:18px}
.header-left img{max-width:220px;height:auto;display:block}
.header-center{text-align:center;color:var(--title)}
.header-center h1{margin:0;font-size:26px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
.header-center .line2{font-size:16px;font-weight:700;color:#1a237e;margin-top:2px}
.header-center .line3{font-size:15px;font-weight:600;color:#1f2f64;margin-top:0}
.header-right{display:flex;align-items:flex-end;justify-content:flex-end}
.badge-no{border:3px solid #79a1f0;border-radius:12px;padding:4px 12px;background:#ffffff;font-weight:700;color:#222}
.section{margin-top:22px}
.section-title{display:flex;gap:10px;align-items:center;font-weight:800;color:#1c274c;font-size:20px;margin:0 0 12px 0}
.badge{background:#e8efff;color:#1a237e;border:1px solid #cdd5ff;border-radius:10px;padding:6px 10px;font-weight:800}
.info{border:1px solid var(--tb);border-radius:14px;overflow:hidden}
.row{display:flex;border-top:1px solid var(--tb)} .row:first-child{border-top:none}
.label{background:var(--alt);min-width:260px;padding:12px 14px;border-right:1px solid var(--tb);font-weight:700;color:#21305e}
.val{flex:1;padding:12px 14px} [contenteditable]{outline:0}
.table{border:1px solid var(--tb);border-radius:14px;overflow:hidden}
.thead{display:flex;background:var(--accent);color:#fff;font-weight:700}
.thead div{flex:1;padding:12px 14px;border-right:1px solid #ffffff55}
.thead div:last-child{border-right:none}
.tbody .row div{flex:1;padding:12px 14px;border-right:1px solid var(--tb)}
#obs{border:1px solid var(--tb);border-radius:14px;min-height:120px;padding:12px 14px}
.sig{border:1px solid var(--tb);border-radius:14px;overflow:hidden;max-width:560px;margin:0 auto}
.fg{border:1px solid var(--tb);border-radius:14px;padding:12px 14px;margin-bottom:16px}
.fg header{font-weight:700;color:#21305e;margin-bottom:8px}
.list{display:flex;gap:12px;flex-wrap:wrap}
.item{position:relative;width:160px;border:2px solid #d7e2ff;border-radius:10px;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.item img{width:100%;display:block;border-bottom:1px solid #e6ecff}
.cap{min-height:38px;padding:6px 8px;font-size:13px}
.btn-del{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;border:1px solid #ccc;background:#fff;color:#d00;font-weight:700;cursor:pointer}
.item[draggable='true']{cursor:grab}.item.dragging{opacity:.6}.drop-target{outline:3px dashed var(--blue-soft);outline-offset:3px;border-color:var(--blue-soft)}
@media print{body{background:#fff;padding:0}.controls{display:none}.sheet{border:1px solid #000;border-radius:0;margin:0;box-shadow:none}}
</style>
</head>
<body>
<div class="controls">
  <button id="bPrint">Imprimir / Guardar PDF</button>
  <button id="bZona">+ Zonas</button>
  <button id="bRes">+ Resultados</button>
  <button id="bFG">+ Fotos</button>
  <button id="bSave">Guardar</button>
  <button id="bLoad">Cargar</button>
  <input type="file" id="fJson" accept="application/json" style="display:none"/>
</div>

<div class="sheet">
  <div class="header">
    <div class="header-left"><img src="assets/logo.png" alt="logo"></div>
    <div class="header-center">
      <h1>INFORME DE INSPECCIÓN</h1>
      <div class="line2">ENSAYOS NO DESTRUCTIVOS</div>
      <div class="line3">PARTÍCULAS MAGNÉTICAS (MT)</div>
    </div>
    <div class="header-right">
      <div id="noBox" class="badge-no">N° <span id="noVal">001</span></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">1</span><span>Antecedentes</span></div>
    <div class="info" id="ant">
      <div class="row"><div class="label">Orden de Trabajo</div><div class="val" contenteditable>505902857/01</div></div>
      <div class="row"><div class="label">Cliente</div><div class="val" contenteditable>INTERCAMBIO O INTERNO CRC</div></div>
      <div class="row"><div class="label">Modelo del Equipo</div><div class="val" contenteditable>793S</div></div>
      <div class="row"><div class="label">Nombre Componente</div><div class="val" contenteditable>CONVERTIDOR TORQUE</div></div>
      <div class="row"><div class="label">Proyecto / Obra</div><div class="val" contenteditable>Contrato X - Planta Y</div></div>
      <div class="row"><div class="label">Ubicación</div><div class="val" contenteditable>Faena / Ciudad / Coordenadas</div></div>
      <div class="row"><div class="label">Norma aplicable</div><div class="val" contenteditable>ISO 5817</div></div>
      <div class="row"><div class="label">Método (END)</div><div class="val" contenteditable>MT – Partículas Magnéticas</div></div>
      <div class="row"><div class="label">Tipo de componente</div><div class="val" contenteditable>Soldadura</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">2</span><span>Técnicas y equipos de inspección (MT)</span></div>
    <div class="info" id="tec">
      <div class="row"><div class="label">Técnica</div><div class="val" contenteditable>Residual</div></div>
      <div class="row"><div class="label">Imantación</div><div class="val" contenteditable>Longitudinal</div></div>
      <div class="row"><div class="label">Partículas magnéticas</div><div class="val" contenteditable>Fluorescentes</div></div>
      <div class="row"><div class="label">Equipo</div><div class="val" contenteditable>Estacionario</div></div>
      <div class="row"><div class="label">Corriente</div><div class="val" contenteditable>1500 A</div></div>
      <div class="row"><div class="label">Marca de equipo</div><div class="val" contenteditable>Indicar marca</div></div>
      <div class="row"><div class="label">Modelo de equipo</div><div class="val" contenteditable>Indicar modelo</div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">3</span><span>Zonas inspeccionadas</span></div>
    <div class="table" id="zonas">
      <div class="thead"><div>Componente</div><div>Descripción</div></div>
      <div class="tbody" id="zonasBody"><div class="row"><div contenteditable>Z1</div><div contenteditable>Carcaza</div></div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">4</span><span>Resultados obtenidos</span></div>
    <div class="table" id="res">
      <div class="thead"><div>Pieza/Zona</div><div>Sin defecto</div><div>Tipo de Defecto</div><div>Cantidad</div><div>Ubicación / Tamaño</div><div>Condición Final</div></div>
      <div class="tbody" id="resBody"><div class="row"><div contenteditable>Z1</div><div contenteditable>-</div><div contenteditable>FISURA</div><div contenteditable>1</div><div contenteditable>VER ANEXO</div><div contenteditable>RECHAZA</div></div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">5</span><span>Observaciones</span></div>
    <div id="obs" contenteditable>Anote aquí detalles generales, recomendaciones y acciones.</div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">6</span><span>Nombre / Cargo – Firma</span></div>
    <div class="sig" id="sig">
      <div class="row"><div class="label">Nombre / Cargo</div><div class="val"><div contenteditable style="border-bottom:1px solid #0f1a2b;min-height:22px">Nombre completo — Cargo</div></div></div>
      <div class="row"><div class="label">Fecha</div><div class="val"><div contenteditable style="border-bottom:1px solid #0f1a2b;min-height:22px">dd/mm/aaaa</div></div></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title"><span class="badge">7</span><span>Anexo Fotográfico</span></div>
    <div id="fgs"></div>
  </div>
</div>

<template id="tplGroup"><div class="fg"><header contenteditable>Nombre del componente</header><div class="list"></div><div style="margin-top:8px"><button class="addFoto" style="padding:8px 12px;border:1px solid #0f1a2b;background:#0f1a2b;color:#fff;border-radius:8px">Cargar fotos</button></div></div></template>
<template id="tplItem"><div class="item" draggable="true"><button class="btn-del" title="Eliminar">×</button><img alt="foto"/><div class="cap" contenteditable>Descripción / hallazgo</div></div></template>

<script>
function uid(){return 'id-'+Math.random().toString(36).slice(2,9);}
function fileToDataURL(file){return new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});}
function pad3(n){return String(n).padStart(3,'0');}

(function(){try{const key='magnatest_seq';let n=parseInt(localStorage.getItem(key)||'0',10);document.getElementById('noVal').innerText=pad3(n+1);document.getElementById('bPrint').addEventListener('click',()=>{n++;localStorage.setItem(key,String(n));document.getElementById('noVal').innerText=pad3(n+1);window.print();});}catch(e){}})();

bPrint.onclick=()=>window.print();
bZona.onclick=()=>{const r=document.createElement('div');r.className='row';r.innerHTML='<div contenteditable> </div><div contenteditable> </div>';zonasBody.appendChild(r);};
bRes.onclick=()=>{const r=document.createElement('div');r.className='row';r.innerHTML='<div contenteditable> </div><div contenteditable> </div><div contenteditable> </div><div contenteditable> </div><div contenteditable> </div><div contenteditable> </div>';resBody.appendChild(r);};
bFG.onclick=()=>addGroup({});

const gTpl=document.getElementById('tplGroup'), iTpl=document.getElementById('tplItem');
function addGroup(data){
  const node=gTpl.content.cloneNode(true);
  const g=node.querySelector('.fg');
  const list=node.querySelector('.list');
  const btn=node.querySelector('.addFoto');
  if(data.header) g.querySelector('header').innerText=data.header;
  (data.fotos||[]).forEach(f=>addItem(list,f));
  btn.onclick=()=>{
    const inp=document.createElement('input');
    inp.type='file'; inp.accept='image/*'; inp.capture='environment'; inp.multiple=true;
    inp.onchange=()=>{Array.from(inp.files||[]).forEach(fl=>fileToDataURL(fl).then(b64=>addItem(list,{src:b64,caption:'Descripción / hallazgo'})));};
    inp.click();
  };
  document.getElementById('fgs').appendChild(node);
}
function addItem(list,data){
  const node=iTpl.content.cloneNode(true);
  const it=node.querySelector('.item');
  const img=node.querySelector('img');
  const cap=node.querySelector('.cap');
  const del=node.querySelector('.btn-del');
  img.src=data.src; cap.innerText=data.caption||'Descripción / hallazgo';
  del.onclick=()=>it.remove();
  it.addEventListener('dragstart',e=>{it.classList.add('dragging'); e.dataTransfer.setData('text/plain','');});
  it.addEventListener('dragend',e=>{it.classList.remove('dragging'); list.querySelectorAll('.item').forEach(x=>x.classList.remove('drop-target'));});
  list.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=list.querySelector('.item.dragging'); if(!dragging) return;
    const after=[...list.querySelectorAll('.item:not(.dragging)')].find(el=>{const r=el.getBoundingClientRect(); return e.clientX < r.left + r.width/2;});
    list.querySelectorAll('.item').forEach(x=>x.classList.remove('drop-target'));
    if(after){ after.classList.add('drop-target'); list.insertBefore(dragging, after); }
    else { list.appendChild(dragging); }
  });
  list.appendChild(node);
}

bSave.onclick=()=>{
  const d=collect();
  try{localStorage.setItem('magnatest_cache',JSON.stringify(d));}catch(e){}
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='informe-magnatest.json'; a.click(); URL.revokeObjectURL(url);
};
bLoad.onclick=()=>fJson.click();
fJson.onchange=()=>{if(!fJson.files[0])return; const r=new FileReader(); r.onload=e=>{const d=JSON.parse(e.target.result); apply(d); try{localStorage.setItem('magnatest_cache',JSON.stringify(d));}catch(e){}}; r.readAsText(fJson.files[0]);};

function collect(){
  const grab=(id)=>{const out=[]; document.getElementById(id).querySelectorAll('.row').forEach(r=>out.push({label:r.querySelector('.label')?r.querySelector('.label').innerText.trim():'', value:r.querySelector('.val')?r.querySelector('.val').innerText.trim():Array.from(r.children)[1]?.innerText.trim()||''})); return out;};
  const zonas=[]; zonasBody.querySelectorAll('.row').forEach(r=>zonas.push({comp:r.children[0].innerText.trim(),desc:r.children[1].innerText.trim()}));
  const resultados=[]; resBody.querySelectorAll('.row').forEach(r=>resultados.push({pieza:r.children[0].innerText.trim(),sin:r.children[1].innerText.trim(),tipo:r.children[2].innerText.trim(),cant:r.children[3].innerText.trim(),ubic:r.children[4].innerText.trim(),cond:r.children[5].innerText.trim()}));
  const fotos=[]; document.querySelectorAll('#fgs .fg').forEach(g=>{const gg={header:g.querySelector('header').innerText.trim(),fotos:[]}; g.querySelectorAll('.item').forEach(it=>gg.fotos.push({src:it.querySelector('img').src, caption:it.querySelector('.cap').innerText.trim()})); fotos.push(gg);});
  return {nro:document.getElementById('noVal').innerText.trim(), antecedentes:grab('ant'), tecnica:grab('tec'), zonas, resultados, obs:document.getElementById('obs').innerText.trim(), firmas:{n:document.querySelector('#sig .row:nth-child(1) .val').innerText.trim(), f:document.querySelector('#sig .row:nth-child(2) .val').innerText.trim()}, fotos};
}
function apply(d){
  if(d.nro) document.getElementById('noVal').innerText=d.nro;
  const fill=(id,rows)=>{const rs=document.getElementById(id).querySelectorAll('.row'); rs.forEach((r,i)=>{const v=r.querySelector('.val'); if(rows[i]&&v) v.innerText=rows[i].value||'';});};
  if(d.antecedentes) fill('ant', d.antecedentes);
  if(d.tecnica) fill('tec', d.tecnica);
  zonasBody.innerHTML=''; (d.zonas||[]).forEach(z=>{const r=document.createElement('div'); r.className='row'; r.innerHTML='<div contenteditable>'+z.comp+'</div><div contenteditable>'+z.desc+'</div>'; zonasBody.appendChild(r);});
  resBody.innerHTML=''; (d.resultados||[]).forEach(x=>{const r=document.createElement('div'); r.className='row'; r.innerHTML='<div contenteditable>'+x.pieza+'</div><div contenteditable>'+x.sin+'</div><div contenteditable>'+x.tipo+'</div><div contenteditable>'+x.cant+'</div><div contenteditable>'+x.ubic+'</div><div contenteditable>'+x.cond+'</div>'; resBody.appendChild(r);});
  document.getElementById('obs').innerText=d.obs||'';
  document.querySelector('#sig .row:nth-child(1) .val').innerText=d.firmas?.n||'';
  document.querySelector('#sig .row:nth-child(2) .val').innerText=d.firmas?.f||'';
  document.getElementById('fgs').innerHTML=''; (d.fotos||[]).forEach(g=>addGroup(g));
}

// restore cache
(function(){try{const c=localStorage.getItem('magnatest_cache'); if(c){apply(JSON.parse(c)); return;}}catch(e){} addGroup({});})();
</script>
</body>
</html>
