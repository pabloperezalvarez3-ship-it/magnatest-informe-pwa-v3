<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<link rel="manifest" href="manifest.webmanifest"/>
<title>Informe de Inspección - MAGNATEST</title>
<style>
:root{
  --bg-body:#0b1220; --bg-sheet:#ffffff; --ring:#c2c8f6; --title:#0f1a2b;
  --accent:#233884; --table-alt:#f6f8ff; --table-border:#dbe1f2;
}
*{box-sizing:border-box} body{margin:0;padding:16px;background:var(--bg-body);font-family:Arial,Helvetica,sans-serif;color:#111}
.controls{max-width:980px;margin:0 auto 16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.controls button{padding:10px 14px;border-radius:10px;border:1px solid #0f1a2b;background:#0f1a2b;color:#fff;font-weight:600}
.sheet{max-width:980px;margin:0 auto;background:var(--bg-sheet);border-radius:18px;box-shadow:0 20px 50px #0006;padding:24px 28px 40px;border:1px solid #0002}

/* Header pill */
.header-pill{border:2px solid var(--ring);border-radius:40px;padding:16px 20px;display:grid;grid-template-columns:240px 1fr 160px;gap:10px;align-items:center;margin-bottom:18px}
.header-left img{max-width:220px;height:auto;display:block}
.header-center{text-align:center;color:var(--title)}
.header-center h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.5px}
.header-center .line2,.header-center .line3{font-weight:700}
.header-center .line4{color:#2c3b6f;font-size:13px;margin-top:6px}
.header-right{font-size:14px;color:#6b7280;display:flex;flex-direction:column;gap:14px;justify-self:end}
.header-right .kv{display:flex;gap:10px;align-items:center}
.header-right .v{min-width:100px;min-height:20px;border-bottom:1px solid #c8cee8;color:#111}

/* Sections */
.section{margin-top:22px}
.section-title{display:flex;align-items:center;gap:10px;font-weight:800;color:#1c274c;margin:0 0 12px 0;font-size:20px}
.badge{background:#e8efff;color:#1a237e;border:1px solid #cdd5ff;border-radius:10px;padding:6px 10px;font-weight:800}

/* Info cards */
.info-card{border:1px solid var(--table-border);border-radius:14px;overflow:hidden}
.info-row{display:flex;border-bottom:1px solid var(--table-border)}
.info-row:last-child{border-bottom:none}
.info-label{background:var(--table-alt);font-weight:700;min-width:260px;padding:12px 14px;border-right:1px solid var(--table-border);color:#21305e}
.info-value{flex:1;padding:12px 14px}
.info-value[contenteditable]{outline:0}

/* Tables (zonas/resultados) */
.table{border:1px solid var(--table-border);border-radius:14px;overflow:hidden}
.table-head{display:flex;background:var(--accent);color:#fff;font-weight:700}
.table-head div{flex:1;padding:12px 14px;border-right:1px solid #ffffff55}
.table-head div:last-child{border-right:none}
.table-row{display:flex;border-top:1px solid var(--table-border)}
.table-row div{flex:1;padding:12px 14px;border-right:1px solid var(--table-border)}
.table-row div:last-child{border-right:none}
.table-row [contenteditable]{outline:0}

/* Observaciones */
#observaciones{border:1px solid var(--table-border);border-radius:14px;min-height:120px;padding:12px 14px;outline:0}

/* Firmas */
.sig-card{border:1px solid var(--table-border);border-radius:14px;overflow:hidden;max-width:560px}
.sig-row{display:flex;border-top:1px solid var(--table-border)}
.sig-row:first-child{border-top:none}
.sig-label{background:var(--table-alt);min-width:220px;padding:12px 14px;border-right:1px solid var(--table-border);font-weight:700;color:#21305e}
.sig-value{flex:1;padding:12px 14px}
.sig-line{min-height:22px;border-bottom:1px solid #0f1a2b;outline:0}

/* Fotos */
#foto-groups{display:flex;flex-direction:column;gap:16px}
.foto-group{border:1px solid var(--table-border);border-radius:14px;padding:12px 14px}
.foto-group header{font-weight:700;color:#21305e;outline:0;margin-bottom:8px}
.foto-list{display:flex;flex-wrap:wrap;gap:12px}
.foto-item{width:150px;border:1px solid var(--table-border);border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 2px 4px #0001}
.foto-item img{width:100%;height:auto;display:block}
.foto-caption{border-top:1px solid var(--table-border);min-height:38px;padding:6px 8px;outline:0;font-size:13px}
.group-actions{display:flex;gap:10px;margin-top:8px}
.group-actions button{padding:8px 12px;font-size:13px}

/* Print */
@media print{
  body{background:#fff;padding:0}
  .controls{display:none}
  .sheet{border:1px solid #000;border-radius:0;margin:0;box-shadow:none}
  .header-pill{page-break-before:avoid}
  .section,.sig-card,.foto-group{page-break-inside:avoid}
}
</style>
</head>
<body>
<div class="controls">
  <button id="btnPrint">Imprimir / Guardar PDF</button>
  <button id="btnZona">+ Zonas</button>
  <button id="btnRes">+ Resultados</button>
  <button id="btnFotos">+ Fotos</button>
  <button id="btnSave">Guardar</button>
  <button id="btnLoad">Cargar</button>
  <input type="file" id="fileJson" accept="application/json" style="display:none"/>
</div>

<div class="sheet">
  <!-- Header -->
  <div class="header-pill">
    <div class="header-left"><img src="assets/logo.png" alt="logo"/></div>
    <div class="header-center">
      <h1>INFORME DE INSPECCIÓN</h1>
      <div class="line2">ENSAYOS NO DESTRUCTIVOS</div>
      <div class="line3">PARTÍCULAS MAGNÉTICAS (MT)</div>
      <div class="line4">Proyecto / Equipo / Fecha – Complete los campos en las tablas.</div>
    </div>
    <div class="header-right">
      <div class="kv"><div>fecha</div><div class="v" id="hdr-fecha" contenteditable="true"></div></div>
      <div class="kv"><div>n°</div><div class="v" id="hdr-nro" contenteditable="true"></div></div>
    </div>
  </div>

  <!-- 1 Antecedentes -->
  <section class="section" id="sec-1">
    <div class="section-title"><span class="badge">1</span><span>Antecedentes</span></div>
    <div class="info-card" id="tabla-antecedentes">
      <div class="info-row"><div class="info-label">Orden de Trabajo</div><div class="info-value" contenteditable="true">505902857/01</div></div>
      <div class="info-row"><div class="info-label">Cliente</div><div class="info-value" contenteditable="true">INTERCAMBIO O INTERNO CRC</div></div>
      <div class="info-row"><div class="info-label">Modelo del Equipo</div><div class="info-value" contenteditable="true">793S</div></div>
      <div class="info-row"><div class="info-label">Nombre Componente</div><div class="info-value" contenteditable="true">CONVERTIDOR TORQUE</div></div>
      <div class="info-row"><div class="info-label">Proyecto / Obra</div><div class="info-value" contenteditable="true">Contrato X - Planta Y</div></div>
      <div class="info-row"><div class="info-label">Ubicación</div><div class="info-value" contenteditable="true">Faena / Ciudad / Coordenadas</div></div>
      <div class="info-row"><div class="info-label">Norma aplicable</div><div class="info-value" contenteditable="true">ISO 5817</div></div>
      <div class="info-row"><div class="info-label">Método (END)</div><div class="info-value" contenteditable="true">MT – Partículas Magnéticas</div></div>
      <div class="info-row"><div class="info-label">Tipo de componente</div><div class="info-value" contenteditable="true">Soldadura</div></div>
    </div>
  </section>

  <!-- 2 Técnicas y equipos de inspección (MT) -->
  <section class="section" id="sec-2">
    <div class="section-title"><span class="badge">2</span><span>Técnicas y equipos de inspección (MT)</span></div>
    <div class="info-card" id="tabla-tecnica">
      <div class="info-row"><div class="info-label">Técnica</div><div class="info-value" contenteditable="true">Residual</div></div>
      <div class="info-row"><div class="info-label">Imantación</div><div class="info-value" contenteditable="true">Longitudinal</div></div>
      <div class="info-row"><div class="info-label">Partículas magnéticas</div><div class="info-value" contenteditable="true">Fluorescentes</div></div>
      <div class="info-row"><div class="info-label">Equipo</div><div class="info-value" contenteditable="true">Estacionario</div></div>
      <div class="info-row"><div class="info-label">Corriente</div><div class="info-value" contenteditable="true">1500 A</div></div>
      <div class="info-row"><div class="info-label">Marca de equipo</div><div class="info-value" contenteditable="true">Indicar marca</div></div>
      <div class="info-row"><div class="info-label">Modelo de equipo</div><div class="info-value" contenteditable="true">Indicar modelo</div></div>
    </div>
  </section>

  <!-- 3 Zonas inspeccionadas -->
  <section class="section" id="sec-3">
    <div class="section-title"><span class="badge">3</span><span>Zonas inspeccionadas</span></div>
    <div class="table" id="tabla-zonas">
      <div class="table-head"><div>Componente</div><div>Descripción</div></div>
      <div class="table-row zona-row"><div class="zona-comp" contenteditable="true">Z1</div><div class="zona-desc" contenteditable="true">Carcaza</div></div>
    </div>
  </section>

  <!-- 4 Resultados obtenidos -->
  <section class="section" id="sec-4">
    <div class="section-title"><span class="badge">4</span><span>Resultados obtenidos</span></div>
    <div class="table" id="tabla-resultados">
      <div class="table-head"><div>Pieza/Zona</div><div>Sin defecto</div><div>Tipo de Defecto</div><div>Cantidad</div><div>Ubicación / Tamaño</div><div>Condición Final</div></div>
      <div class="table-row resultado-row">
        <div class="res-pieza" contenteditable="true">Z1</div>
        <div class="res-sin" contenteditable="true">-</div>
        <div class="res-tipo" contenteditable="true">FISURA</div>
        <div class="res-cant" contenteditable="true">1</div>
        <div class="res-ubic" contenteditable="true">VER ANEXO</div>
        <div class="res-cond" contenteditable="true">RECHAZA</div>
      </div>
    </div>
  </section>

  <!-- 5 Observaciones -->
  <section class="section" id="sec-5">
    <div class="section-title"><span class="badge">5</span><span>Observaciones</span></div>
    <div id="observaciones" contenteditable="true">Anote aquí detalles generales, recomendaciones y acciones.</div>
  </section>

  <!-- 6 Firmas -->
  <section class="section" id="sec-6">
    <div class="section-title"><span class="badge">6</span><span>Nombre / Cargo – Firma</span></div>
    <div class="sig-card" id="tabla-firmas">
      <div class="sig-row"><div class="sig-label">Nombre / Cargo</div><div class="sig-value"><div class="sig-line" contenteditable="true">Nombre completo — Cargo</div></div></div>
      <div class="sig-row"><div class="sig-label">Fecha</div><div class="sig-value"><div class="sig-line" contenteditable="true">dd/mm/aaaa</div></div></div>
    </div>
  </section>

  <!-- 7 Anexo Fotográfico -->
  <section class="section" id="sec-7">
    <div class="section-title"><span class="badge">7</span><span>Anexo Fotográfico</span></div>
    <div id="foto-groups"></div>
  </section>
</div>

<!-- Templates -->
<template id="tpl-foto-group">
  <div class="foto-group">
    <header contenteditable="true">Nombre del componente</header>
    <div class="foto-list"></div>
    <div class="group-actions"><button class="btn-add-foto">Cargar fotos</button></div>
  </div>
</template>

<template id="tpl-foto-item">
  <div class="foto-item">
    <img alt="foto evidencia"/>
    <div class="foto-caption" contenteditable="true">Descripción / hallazgo</div>
  </div>
</template>

<script>
function uid(){return 'id-'+Math.random().toString(36).slice(2,9);}

// Controls
btnPrint.onclick=()=>window.print();
btnZona.onclick=()=>addZonaRow({});
btnRes.onclick=()=>addResultadoRow({});
btnFotos.onclick=()=>addFotoGroup({});
btnSave.onclick=()=>{const d=collectData();try{localStorage.setItem('magnatest_cache',JSON.stringify(d));}catch(e){} downloadJSON(d);};
btnLoad.onclick=()=>fileJson.click();
fileJson.onchange=()=>{const f=fileJson.files&&fileJson.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{const d=JSON.parse(e.target.result); applyData(d); try{localStorage.setItem('magnatest_cache',JSON.stringify(d));}catch(e){}}; r.readAsText(f);};

// Dynamic rows
function addZonaRow(d){
  const row=document.createElement('div');
  row.className='table-row zona-row';
  row.innerHTML='<div class="zona-comp" contenteditable="true">'+(d.comp||'')+'</div><div class="zona-desc" contenteditable="true">'+(d.desc||'')+'</div>';
  document.getElementById('tabla-zonas').appendChild(row);
}
function addResultadoRow(d){
  const row=document.createElement('div');
  row.className='table-row resultado-row';
  row.innerHTML=[
    '<div class="res-pieza" contenteditable="true">'+(d.pieza||'')+'</div>',
    '<div class="res-sin" contenteditable="true">'+(d.sin||'')+'</div>',
    '<div class="res-tipo" contenteditable="true">'+(d.tipo||'')+'</div>',
    '<div class="res-cant" contenteditable="true">'+(d.cant||'')+'</div>',
    '<div class="res-ubic" contenteditable="true">'+(d.ubic||'')+'</div>',
    '<div class="res-cond" contenteditable="true">'+(d.cond||'')+'</div>'
  ].join('');
  document.getElementById('tabla-resultados').appendChild(row);
}

// Photos
const fotoGroupsEl = document.getElementById('foto-groups');
const tplGroup = document.getElementById('tpl-foto-group');
const tplItem  = document.getElementById('tpl-foto-item');

function addFotoGroup(data){
  const node=tplGroup.content.cloneNode(true);
  const grp=node.querySelector('.foto-group');
  const list=node.querySelector('.foto-list');
  const header=node.querySelector('header');
  const btn=node.querySelector('.btn-add-foto');
  grp.dataset.gid=data&&data.gid||uid();
  if(data&&data.header) header.innerText=data.header;
  (data&&data.fotos||[]).forEach(f=>addFotoItem(list,f));
  btn.onclick=()=>{pickImages().then(files=>{files.forEach(fl=>{fileToDataURL(fl).then(b64=>addFotoItem(list,{src:b64,caption:'Descripción / hallazgo'}));});});};
  fotoGroupsEl.appendChild(node);
}
function addFotoItem(list,data){
  const n=tplItem.content.cloneNode(true);
  n.querySelector('img').src=data.src;
  n.querySelector('.foto-caption').innerText=data.caption||'Descripción / hallazgo';
  list.appendChild(n);
}
function pickImages(){
  return new Promise(res=>{
    const i=document.createElement('input');
    i.type='file'; i.accept='image/*'; i.capture='environment'; i.multiple=true;
    i.onchange=()=>res(Array.from(i.files||[]));
    i.click();
  });
}
function fileToDataURL(file){return new Promise(r=>{const fr=new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsDataURL(file);});}

// Save/Load helpers
function grabInfoRows(cardId){
  const out=[]; document.getElementById(cardId).querySelectorAll('.info-row').forEach(r=>{
    out.push({label:r.querySelector('.info-label').innerText.trim(), value:r.querySelector('.info-value').innerText.trim()});
  }); return out;
}
function collectData(){
  const antecedentes = grabInfoRows('tabla-antecedentes');
  const tecnica      = grabInfoRows('tabla-tecnica');
  const zonas=[]; document.querySelectorAll('#tabla-zonas .zona-row').forEach(r=>zonas.push({comp:r.children[0].innerText.trim(),desc:r.children[1].innerText.trim()}));
  const resultados=[]; document.querySelectorAll('#tabla-resultados .resultado-row').forEach(r=>resultados.push({pieza:r.children[0].innerText.trim(),sin:r.children[1].innerText.trim(),tipo:r.children[2].innerText.trim(),cant:r.children[3].innerText.trim(),ubic:r.children[4].innerText.trim(),cond:r.children[5].innerText.trim()}));
  const observaciones = document.getElementById('observaciones').innerText.trim();
  const firmas = {
    nombreCargo: document.querySelector('#tabla-firmas .sig-line').innerText.trim(),
    fecha: document.querySelector('#tabla-firmas .sig-row:nth-child(2) .sig-line').innerText.trim()
  };
  const hdr = {fecha:document.getElementById('hdr-fecha').innerText.trim(), nro:document.getElementById('hdr-nro').innerText.trim()};
  const fotos=[]; document.querySelectorAll('#foto-groups .foto-group').forEach(g=>{
    const gg={gid:g.dataset.gid, header:g.querySelector('header').innerText.trim(), fotos:[]};
    g.querySelectorAll('.foto-item').forEach(it=>gg.fotos.push({src:it.querySelector('img').src, caption:it.querySelector('.foto-caption').innerText.trim()}));
    fotos.push(gg);
  });
  return {hdr, antecedentes, tecnica, zonas, resultados, observaciones, firmas, fotos};
}
function applyData(d){
  function setInfoRows(cardId, rows){const rs=document.getElementById(cardId).querySelectorAll('.info-row'); rs.forEach((r,i)=>{if(rows[i]) r.querySelector('.info-value').innerText = rows[i].value || '';});}
  if(d.hdr){document.getElementById('hdr-fecha').innerText=d.hdr.fecha||''; document.getElementById('hdr-nro').innerText=d.hdr.nro||'';}
  if(d.antecedentes) setInfoRows('tabla-antecedentes', d.antecedentes);
  if(d.tecnica)      setInfoRows('tabla-tecnica', d.tecnica);
  document.querySelectorAll('#tabla-zonas .zona-row').forEach(x=>x.remove()); (d.zonas||[]).forEach(z=>addZonaRow(z));
  document.querySelectorAll('#tabla-resultados .resultado-row').forEach(x=>x.remove()); (d.resultados||[]).forEach(r=>addResultadoRow(r));
  if(d.observaciones) document.getElementById('observaciones').innerText = d.observaciones;
  if(d.firmas){ document.querySelector('#tabla-firmas .sig-line').innerText = d.firmas.nombreCargo || ''; document.querySelector('#tabla-firmas .sig-row:nth-child(2) .sig-line').innerText = d.firmas.fecha || ''; }
  fotoGroupsEl.innerHTML=''; (d.fotos||[]).forEach(g=>addFotoGroup(g));
}
function downloadJSON(obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='informe-magnatest.json'; a.click(); URL.revokeObjectURL(url);}

// Restore cache
(function init(){
  try{const c=localStorage.getItem('magnatest_cache'); if(c){applyData(JSON.parse(c)); return;}}catch(e){}
  addFotoGroup({});
})();

// Register SW
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
